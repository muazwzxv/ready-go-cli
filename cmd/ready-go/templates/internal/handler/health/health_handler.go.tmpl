package handler

import (
	"time"

	"github.com/gofiber/fiber/v2"
	"{{.ModuleName}}/internal/dto/response"
)

type DatabaseService interface {
	Ping() error
}

type HealthHandler struct {
	dbService DatabaseService
	version   string
}

func NewHealthHandler(dbService DatabaseService, version string) *HealthHandler {
	return &HealthHandler{
		dbService: dbService,
		version:   version,
	}
}

func (h *HealthHandler) RegisterRoutes(app *fiber.App) {
	app.Get("/health", h.HealthCheck)
	app.Get("/health/ready", h.ReadinessCheck)
}

func (h *HealthHandler) HealthCheck(c *fiber.Ctx) error {
	healthResp := response.HealthResponse{
		Status:    "healthy",
		Timestamp: time.Now(),
		Version:   h.version,
		Services:  make(map[string]response.ServiceHealth),
	}

	if h.dbService != nil {
		if err := h.dbService.Ping(); err != nil {
			healthResp.Services["database"] = response.ServiceHealth{
				Status:  "unhealthy",
				Message: "Database connection failed: " + err.Error(),
			}
			healthResp.Status = "degraded"
		} else {
			healthResp.Services["database"] = response.ServiceHealth{
				Status:  "healthy",
				Message: "Connected",
			}
		}
	}

	statusCode := fiber.StatusOK
	if healthResp.Status == "degraded" {
		statusCode = fiber.StatusServiceUnavailable
	}

	return c.Status(statusCode).JSON(healthResp)
}

func (h *HealthHandler) ReadinessCheck(c *fiber.Ctx) error {
	if h.dbService != nil {
		if err := h.dbService.Ping(); err != nil {
			return c.Status(fiber.StatusServiceUnavailable).JSON(response.ErrorResponse{
				Error:   "service_unavailable",
				Message: "Service not ready: database unavailable",
			})
		}
	}

	return c.JSON(fiber.Map{
		"status": "ready",
		"time":   time.Now().Unix(),
	})
}

func (h *HealthHandler) LivenessCheck(c *fiber.Ctx) error {
	return c.JSON(fiber.Map{
		"status": "alive",
		"time":   time.Now().Unix(),
	})
}
