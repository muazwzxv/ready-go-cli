package service

import (
	"fmt"

	"{{.ModuleName}}/internal/dto/request"
	"{{.ModuleName}}/internal/dto/response"
	"{{.ModuleName}}/internal/entity"
	"{{.ModuleName}}/internal/repository"
)

// {{.SampleAPIName}}ServiceImpl implements {{.SampleAPIName}}Service interface
type {{.SampleAPIName}}ServiceImpl struct {
	repo repository.{{.SampleAPIName}}Repository
}

// New{{.SampleAPIName}}Service creates a new {{.SampleAPINameLower}} service instance
func New{{.SampleAPIName}}Service(repo repository.{{.SampleAPIName}}Repository) {{.SampleAPIName}}Service {
	return &{{.SampleAPIName}}ServiceImpl{
		repo: repo,
	}
}

// Create{{.SampleAPIName}} creates a new {{.SampleAPINameLower}}
func (s *{{.SampleAPIName}}ServiceImpl) Create{{.SampleAPIName}}(req request.Create{{.SampleAPIName}}Request) (*response.{{.SampleAPIName}}Response, error) {
	// Set default status if not provided
	status := entity.{{.SampleAPIName}}StatusActive
	if req.Status != "" {
		status = entity.{{.SampleAPIName}}Status(req.Status)
	}

	// Create {{.SampleAPINameLower}} entity
	item := &entity.{{.SampleAPIName}}{
		Name:        req.Name,
		Description: req.Description,
		Status:      status,
	}

	// Save to repository
	if err := s.repo.Create(item); err != nil {
		return nil, fmt.Errorf("failed to create {{.SampleAPINameLower}}: %w", err)
	}

	return s.entityToResponse(item), nil
}

// Get{{.SampleAPIName}} retrieves a {{.SampleAPINameLower}} by ID
func (s *{{.SampleAPIName}}ServiceImpl) Get{{.SampleAPIName}}(id int64) (*response.{{.SampleAPIName}}Response, error) {
	item, err := s.repo.GetByID(id)
	if err != nil {
		return nil, fmt.Errorf("failed to get {{.SampleAPINameLower}}: %w", err)
	}

	return s.entityToResponse(item), nil
}

// List{{.SampleAPIName}}s retrieves {{.SampleAPINameLower}}s with pagination, sorting, and filtering
func (s *{{.SampleAPIName}}ServiceImpl) List{{.SampleAPIName}}s(req request.List{{.SampleAPIName}}sRequest) (*response.{{.SampleAPIName}}ListResponse, error) {
	items, totalCount, err := s.repo.List(req)
	if err != nil {
		return nil, fmt.Errorf("failed to list {{.SampleAPINameLower}}s: %w", err)
	}

	// Convert to response format
	itemResps := make([]response.{{.SampleAPIName}}Response, len(items))
	for i, item := range items {
		itemResps[i] = *s.entityToResponse(&item)
	}

	// Create pagination metadata
	pagination := response.NewPaginationMetadata(req.Page, req.PageSize, totalCount)

	return &response.{{.SampleAPIName}}ListResponse{
		{{.SampleAPIName}}s: itemResps,
		Pagination:         pagination,
	}, nil
}

// Update{{.SampleAPIName}} updates an existing {{.SampleAPINameLower}}
func (s *{{.SampleAPIName}}ServiceImpl) Update{{.SampleAPIName}}(id int64, req request.Update{{.SampleAPIName}}Request) (*response.{{.SampleAPIName}}Response, error) {
	// Get existing {{.SampleAPINameLower}}
	item, err := s.repo.GetByID(id)
	if err != nil {
		return nil, fmt.Errorf("failed to get {{.SampleAPINameLower}} for update: %w", err)
	}

	// Update fields if provided
	if req.Name != nil {
		item.Name = *req.Name
	}
	if req.Description != nil {
		item.Description = *req.Description
	}
	if req.Status != nil {
		item.Status = entity.{{.SampleAPIName}}Status(*req.Status)
	}

	// Save changes
	if err := s.repo.Update(item); err != nil {
		return nil, fmt.Errorf("failed to update {{.SampleAPINameLower}}: %w", err)
	}

	return s.entityToResponse(item), nil
}

// Delete{{.SampleAPIName}} removes a {{.SampleAPINameLower}}
func (s *{{.SampleAPIName}}ServiceImpl) Delete{{.SampleAPIName}}(id int64) error {
	// Check if {{.SampleAPINameLower}} exists
	exists, err := s.repo.ExistsByID(id)
	if err != nil {
		return fmt.Errorf("failed to check {{.SampleAPINameLower}} existence: %w", err)
	}
	if !exists {
		return fmt.Errorf("{{.SampleAPINameLower}} not found")
	}

	// Delete {{.SampleAPINameLower}}
	if err := s.repo.Delete(id); err != nil {
		return fmt.Errorf("failed to delete {{.SampleAPINameLower}}: %w", err)
	}

	return nil
}

// BulkUpdateStatus updates the status of multiple {{.SampleAPINameLower}}s
func (s *{{.SampleAPIName}}ServiceImpl) BulkUpdateStatus(req request.Bulk{{.SampleAPIName}}Request) (*response.Bulk{{.SampleAPIName}}Response, error) {
	status := entity.{{.SampleAPIName}}Status(req.Status)

	// Validate status
	if !status.IsValid() {
		return nil, fmt.Errorf("invalid status: %s", req.Status)
	}

	// Perform bulk update
	updatedCount, failedIDs, err := s.repo.BulkUpdateStatus(req.IDs, status)
	if err != nil {
		return nil, fmt.Errorf("failed to bulk update status: %w", err)
	}

	message := fmt.Sprintf("Successfully updated %d {{.SampleAPINameLower}}s", updatedCount)
	if len(failedIDs) > 0 {
		message = fmt.Sprintf("Updated %d {{.SampleAPINameLower}}s, failed to update %d", updatedCount, len(failedIDs))
	}

	return &response.Bulk{{.SampleAPIName}}Response{
		UpdatedCount: updatedCount,
		FailedIDs:    failedIDs,
		Message:      message,
	}, nil
}

// Get{{.SampleAPIName}}Stats retrieves statistics about {{.SampleAPINameLower}}s
func (s *{{.SampleAPIName}}ServiceImpl) Get{{.SampleAPIName}}Stats() (*response.{{.SampleAPIName}}StatsResponse, error) {
	// Get total count
	totalCount, err := s.repo.Count()
	if err != nil {
		return nil, fmt.Errorf("failed to get total count: %w", err)
	}

	// Get count by status
	activeCount, err := s.repo.CountByStatus(entity.{{.SampleAPIName}}StatusActive)
	if err != nil {
		return nil, fmt.Errorf("failed to get active count: %w", err)
	}

	inactiveCount, err := s.repo.CountByStatus(entity.{{.SampleAPIName}}StatusInactive)
	if err != nil {
		return nil, fmt.Errorf("failed to get inactive count: %w", err)
	}

	archivedCount, err := s.repo.CountByStatus(entity.{{.SampleAPIName}}StatusArchived)
	if err != nil {
		return nil, fmt.Errorf("failed to get archived count: %w", err)
	}

	return &response.{{.SampleAPIName}}StatsResponse{
		TotalCount:    totalCount,
		ActiveCount:   activeCount,
		InactiveCount: inactiveCount,
		ArchivedCount: archivedCount,
	}, nil
}

// entityToResponse converts a {{.SampleAPINameLower}} entity to a response
func (s *{{.SampleAPIName}}ServiceImpl) entityToResponse(item *entity.{{.SampleAPIName}}) *response.{{.SampleAPIName}}Response {
	return &response.{{.SampleAPIName}}Response{
		ID:          item.ID,
		Name:        item.Name,
		Description: item.Description,
		Status:      item.Status,
		CreatedAt:   item.CreatedAt,
		UpdatedAt:   item.UpdatedAt,
		IsActive:    item.IsActive(),
	}
}
