// Package config provides configuration loading from multiple sources using Viper.
package config

import (
	"fmt"
	"strings"
	"time"

	"github.com/spf13/viper"
)

// Config holds all application configuration
type Config struct {
	Server   ServerConfig   `mapstructure:"server"`
	Database DatabaseConfig `mapstructure:"database"`
}

// ServerConfig holds Fiber server configuration
type ServerConfig struct {
	Host         string        `mapstructure:"host"`
	Port         int           `mapstructure:"port"`
	ReadTimeout  time.Duration `mapstructure:"read_timeout"`
	WriteTimeout time.Duration `mapstructure:"write_timeout"`
	BodyLimit    int           `mapstructure:"body_limit"`
	Prefork      bool          `mapstructure:"prefork"`
}

// DatabaseConfig holds database configuration
type DatabaseConfig struct {
	Host            string        `mapstructure:"host"`
	Port            int           `mapstructure:"port"`
	User            string        `mapstructure:"user"`
	Password        string        `mapstructure:"password"`
	Database        string        `mapstructure:"database"`
	MaxOpenConns    int           `mapstructure:"max_open_conns"`
	MaxIdleConns    int           `mapstructure:"max_idle_conns"`
	ConnMaxLifetime time.Duration `mapstructure:"conn_max_lifetime"`
	RetryAttempts   int           `mapstructure:"retry_attempts"`
	RetryBackoff    time.Duration `mapstructure:"retry_backoff"`
}

// LoadConfig loads configuration from TOML file and environment variables.
//
// Configuration priority (highest to lowest):
//  1. Environment variables
//  2. config.toml file
//
// Environment variable naming convention:
//   - Nested config keys are flattened with underscores
//   - All uppercase
//   - Examples:
//     server.host              → SERVER_HOST
//     server.port              → SERVER_PORT
//     database.host            → DATABASE_HOST
//     database.max_open_conns  → DATABASE_MAX_OPEN_CONNS
func LoadConfig() (*Config, error) {
	v := viper.New()

	// Configure config file
	v.SetConfigName("config")
	v.SetConfigType("toml")
	v.AddConfigPath(".")
	v.AddConfigPath("/etc/{{.ProjectName}}/")
	v.AddConfigPath("$HOME/.{{.ProjectName}}")

	// Read config file (optional - don't fail if not found)
	if err := v.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
			// Config file was found but another error occurred
			return nil, fmt.Errorf("read config file: %w", err)
		}
		// Config file not found; will use environment variables only
	}

	// Enable automatic environment variable override
	v.AutomaticEnv()
	v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))

	// Unmarshal into struct
	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, fmt.Errorf("unmarshal config: %w", err)
	}

	return &cfg, nil
}

// Load reads configuration from a TOML file (backward compatibility).
func Load(path string) (*Config, error) {
	v := viper.New()

	// Read specific config file
	v.SetConfigFile(path)
	if err := v.ReadInConfig(); err != nil {
		return nil, fmt.Errorf("read config file: %w", err)
	}

	// Unmarshal into struct
	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, fmt.Errorf("unmarshal config: %w", err)
	}

	return &cfg, nil
}
