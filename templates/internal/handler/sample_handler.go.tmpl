// Package handler contains HTTP request handlers for the API.
package handler

import (
	"strconv"

	"github.com/gofiber/fiber/v2"
	"{{.ModuleName}}/internal/dto/request"
	"{{.ModuleName}}/internal/dto/response"
	"{{.ModuleName}}/internal/service"
)

// {{.SampleAPIName}}Handler handles HTTP requests for {{.SampleAPINameLower}} operations
type {{.SampleAPIName}}Handler struct {
	service service.{{.SampleAPIName}}Service
}

// New{{.SampleAPIName}}Handler creates a new {{.SampleAPINameLower}} handler
func New{{.SampleAPIName}}Handler(service service.{{.SampleAPIName}}Service) *{{.SampleAPIName}}Handler {
	return &{{.SampleAPIName}}Handler{
		service: service,
	}
}

// Create{{.SampleAPIName}} handles POST /api/v1/{{.SampleAPINameLower}}s
func (h *{{.SampleAPIName}}Handler) Create{{.SampleAPIName}}(c *fiber.Ctx) error {
	var req request.Create{{.SampleAPIName}}Request
	if err := c.BodyParser(&req); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(
			response.BadRequestErrorResponse("Invalid request body"),
		)
	}

	// TODO: Add validation here

	itemResp, err := h.service.Create{{.SampleAPIName}}(req)
	if err != nil {
		return c.Status(fiber.StatusInternalServerError).JSON(
			response.InternalServerErrorResponse("Failed to create {{.SampleAPINameLower}}"),
		)
	}

	return c.Status(fiber.StatusCreated).JSON(response.Create{{.SampleAPIName}}Response{
		ID:      itemResp.ID,
		Message: "{{.SampleAPIName}} created successfully",
	})
}

// Get{{.SampleAPIName}} handles GET /api/v1/{{.SampleAPINameLower}}s/:id
func (h *{{.SampleAPIName}}Handler) Get{{.SampleAPIName}}(c *fiber.Ctx) error {
	idParam := c.Params("id")
	if idParam == "" {
		return c.Status(fiber.StatusBadRequest).JSON(
			response.BadRequestErrorResponse("{{.SampleAPIName}} ID is required"),
		)
	}

	id, err := strconv.ParseInt(idParam, 10, 64)
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(
			response.BadRequestErrorResponse("Invalid {{.SampleAPINameLower}} ID"),
		)
	}

	item, err := h.service.Get{{.SampleAPIName}}(id)
	if err != nil {
		return c.Status(fiber.StatusNotFound).JSON(
			response.NotFoundErrorResponse("{{.SampleAPIName}}"),
		)
	}

	return c.JSON(item)
}

// Update{{.SampleAPIName}} handles PUT /api/v1/{{.SampleAPINameLower}}s/:id
func (h *{{.SampleAPIName}}Handler) Update{{.SampleAPIName}}(c *fiber.Ctx) error {
	idParam := c.Params("id")
	if idParam == "" {
		return c.Status(fiber.StatusBadRequest).JSON(
			response.BadRequestErrorResponse("{{.SampleAPIName}} ID is required"),
		)
	}

	id, err := strconv.ParseInt(idParam, 10, 64)
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(
			response.BadRequestErrorResponse("Invalid {{.SampleAPINameLower}} ID"),
		)
	}

	var req request.Update{{.SampleAPIName}}Request
	if err := c.BodyParser(&req); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(
			response.BadRequestErrorResponse("Invalid request body"),
		)
	}

	// TODO: Add validation here

	itemResp, err := h.service.Update{{.SampleAPIName}}(id, req)
	if err != nil {
		return c.Status(fiber.StatusInternalServerError).JSON(
			response.InternalServerErrorResponse("Failed to update {{.SampleAPINameLower}}"),
		)
	}

	return c.JSON(response.Update{{.SampleAPIName}}Response{
		ID:      itemResp.ID,
		Message: "{{.SampleAPIName}} updated successfully",
		Updated: true,
	})
}

// List{{.SampleAPIName}}s handles GET /api/v1/{{.SampleAPINameLower}}s
func (h *{{.SampleAPIName}}Handler) List{{.SampleAPIName}}s(c *fiber.Ctx) error {
	// Parse pagination parameters
	page, err := strconv.Atoi(c.Query("page", "1"))
	if err != nil || page < 1 {
		page = 1
	}

	pageSize, err := strconv.Atoi(c.Query("page_size", "20"))
	if err != nil || pageSize < 1 || pageSize > 100 {
		pageSize = 20
	}

	// Parse filter parameters
	var nameFilter *string
	if name := c.Query("name"); name != "" {
		nameFilter = &name
	}

	var statusFilter *string
	if status := c.Query("status"); status != "" {
		statusFilter = &status
	}

	var fromDate *string
	if from := c.Query("from_date"); from != "" {
		fromDate = &from
	}

	var toDate *string
	if to := c.Query("to_date"); to != "" {
		toDate = &to
	}

	// Parse sort parameters
	sortBy := c.Query("sort_by", "created_at")
	sortOrder := c.Query("sort_order", "desc")

	req := request.List{{.SampleAPIName}}sRequest{
		PaginationRequest: request.PaginationRequest{
			Page:     page,
			PageSize: pageSize,
		},
		SortRequest: request.SortRequest{
			SortBy:    sortBy,
			SortOrder: sortOrder,
		},
		FilterRequest: request.FilterRequest{
			Name:     nameFilter,
			Status:   statusFilter,
			FromDate: fromDate,
			ToDate:   toDate,
		},
	}

	listResp, err := h.service.List{{.SampleAPIName}}s(req)
	if err != nil {
		return c.Status(fiber.StatusInternalServerError).JSON(
			response.InternalServerErrorResponse("Failed to list {{.SampleAPINameLower}}s"),
		)
	}

	return c.JSON(listResp)
}

// Delete{{.SampleAPIName}} handles DELETE /api/v1/{{.SampleAPINameLower}}s/:id
func (h *{{.SampleAPIName}}Handler) Delete{{.SampleAPIName}}(c *fiber.Ctx) error {
	idParam := c.Params("id")
	if idParam == "" {
		return c.Status(fiber.StatusBadRequest).JSON(
			response.BadRequestErrorResponse("{{.SampleAPIName}} ID is required"),
		)
	}

	id, err := strconv.ParseInt(idParam, 10, 64)
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(
			response.BadRequestErrorResponse("Invalid {{.SampleAPINameLower}} ID"),
		)
	}

	if err := h.service.Delete{{.SampleAPIName}}(id); err != nil {
		if err.Error() == "{{.SampleAPINameLower}} not found" {
			return c.Status(fiber.StatusNotFound).JSON(
				response.NotFoundErrorResponse("{{.SampleAPIName}}"),
			)
		}
		return c.Status(fiber.StatusInternalServerError).JSON(
			response.InternalServerErrorResponse("Failed to delete {{.SampleAPINameLower}}"),
		)
	}

	return c.JSON(response.SuccessResponse{
		Success: true,
		Message: "{{.SampleAPIName}} deleted successfully",
	})
}

// BulkUpdateStatus handles POST /api/v1/{{.SampleAPINameLower}}s/bulk-update-status
func (h *{{.SampleAPIName}}Handler) BulkUpdateStatus(c *fiber.Ctx) error {
	var req request.Bulk{{.SampleAPIName}}Request
	if err := c.BodyParser(&req); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(
			response.BadRequestErrorResponse("Invalid request body"),
		)
	}

	// TODO: Add validation here

	bulkResp, err := h.service.BulkUpdateStatus(req)
	if err != nil {
		return c.Status(fiber.StatusInternalServerError).JSON(
			response.InternalServerErrorResponse("Failed to bulk update status"),
		)
	}

	return c.JSON(bulkResp)
}

// Get{{.SampleAPIName}}Stats handles GET /api/v1/{{.SampleAPINameLower}}s/stats
func (h *{{.SampleAPIName}}Handler) Get{{.SampleAPIName}}Stats(c *fiber.Ctx) error {
	stats, err := h.service.Get{{.SampleAPIName}}Stats()
	if err != nil {
		return c.Status(fiber.StatusInternalServerError).JSON(
			response.InternalServerErrorResponse("Failed to get {{.SampleAPINameLower}} statistics"),
		)
	}

	return c.JSON(stats)
}
