package handler

import (
	"log"

	"github.com/gofiber/fiber/v2"
	"github.com/gofiber/fiber/v2/middleware/logger"
	"{{.ModuleName}}/internal/dto/response"
)

// RequestLoggerMiddleware creates a request logging middleware
func RequestLoggerMiddleware() fiber.Handler {
	return logger.New(logger.Config{
		Format: "[${time}] ${status} - ${method} ${path} - ${latency}\n",
	})
}

// ErrorHandlerMiddleware creates a centralized error handling middleware
func ErrorHandlerMiddleware() fiber.Handler {
	return func(c *fiber.Ctx) error {
		err := c.Next()
		if err != nil {
			log.Printf("Request error: %v", err)
			return response.HandleError(c, err)
		}
		return nil
	}
}

// CORSMiddleware creates a CORS middleware for development
func CORSMiddleware() fiber.Handler {
	return func(c *fiber.Ctx) error {
		c.Set("Access-Control-Allow-Origin", "*")
		c.Set("Access-Control-Allow-Methods", "GET,POST,PUT,DELETE,OPTIONS")
		c.Set("Access-Control-Allow-Headers", "Origin, Content-Type, Accept, Authorization")

		if c.Method() == "OPTIONS" {
			return c.SendStatus(fiber.StatusNoContent)
		}

		return c.Next()
	}
}

// ContentTypeMiddleware ensures proper content type for API responses
func ContentTypeMiddleware() fiber.Handler {
	return func(c *fiber.Ctx) error {
		// Set default content type for API responses
		if c.Path() != "/health" && c.Path() != "/ready" && c.Path() != "/live" {
			c.Set("Content-Type", "application/json")
		}
		return c.Next()
	}
}
